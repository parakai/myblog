{% extends 'base.html' %}
{% load static %}
{% block title %}我的博客|树形结构{% endblock %}
{% block custom_css %}
{#    <link rel="stylesheet" href="{% static 'zTree/css/zTreeStyle.css' %}">#}
    <link rel="stylesheet" href="{% static 'zTree/css/zTreeStyle.css' %}">
    <style type="text/css">
    div.content_wrap {width: 600px;height:380px;}
    div.content_wrap div.left{float: left;width: 250px;}
    ul.ztree {margin-top: 10px;border: 1px solid #617775;background: #f0f6e4;width:220px;height:360px;overflow-y:scroll;overflow-x:auto;}
    div#rMenu {position:absolute; visibility:hidden; top:0; background-color: #555;text-align: left;padding: 2px;}
    div#rMenu ul li{
        margin: 1px 0;
        padding: 0 5px;
        cursor: pointer;
        list-style: none outside none;
        background-color: #DFDFDF;
    }
	</style>
{% endblock %}
{% block content %}
<h2>右键菜单的实现树形结构</h2>
    <div class="content_wrap">
    	<div class="zTreeDemoBackground left">
		    <ul id="treeDemo" class="ztree"></ul>
	    </div>
    </div>
    <div id="rMenu">
        <ul class="dropdown-menu">
            <li id="m_add" tabindex="-1" onclick="addTreeNode();"><a><i class="fa fa-plus-square-o"></i>新建节点</a></li>
            <li id="m_del" tabindex="-1" onclick="editTreeNode();"><a><i class="fa fa-pencil-square-o"></i>重命名节点</a></li>
            <li id="m_del" tabindex="-1" onclick="removeTreeNode();"><a><i class="fa fa-minus-square"></i>删除节点</a></li>
            <li id="menu_asset_add" class="btn-add-asset" data-toggle="modal" data-target="#asset_list_modal" tabindex="0"><a><i class="fa fa-copy"></i> 添加资产到节点</a></li>
            <li id="menu_asset_move" class="btn-move-asset" data-toggle="modal" data-target="#asset_list_modal" tabindex="0"><a><i class="fa fa-cut"></i> 移动资产到节点</a></li>
        </ul>
    </div>
{% endblock %}
{% block custom_js %}
    <script src="{% static 'zTree/js/jquery.ztree.all.min.js' %}"></script>
    <script type="text/javascript">
		function OnRightClick(event, treeId, treeNode) {
			if (!treeNode && event.target.tagName.toLowerCase() != "button" && $(event.target).parents("a").length == 0) {
				zTree.cancelSelectedNode();
				showRMenu("root", event.clientX, event.clientY);
			} else if (treeNode && !treeNode.noR) {
				zTree.selectNode(treeNode);
				showRMenu("node", event.clientX, event.clientY);
			}
		}

		function showRMenu(type, x, y) {
			$("#rMenu ul").show();
			if (type=="root") {
				$("#m_del").hide();
				$("#m_check").hide();
				$("#m_unCheck").hide();
			} else {
				$("#m_del").show();
				$("#m_check").show();
				$("#m_unCheck").show();
			}

            y += document.body.scrollTop;
            x += document.body.scrollLeft;
            rMenu.css({"top":y+"px", "left":x+"px", "visibility":"visible"});

			$("body").bind("mousedown", onBodyMouseDown);
		}
		function hideRMenu() {
			if (rMenu) rMenu.css({"visibility": "hidden"});
			$("body").unbind("mousedown", onBodyMouseDown);
		}
		function onBodyMouseDown(event){
			if (!(event.target.id == "rMenu" || $(event.target).parents("#rMenu").length>0)) {
				rMenu.css({"visibility" : "hidden"});
			}
		}
		function addTreeNode() {
			hideRMenu();
			var parentNode = zTree.getSelectedNodes()[0]; //选中的当前节点
            if(!parentNode){
                return;
            }
            var url = "{% url 'node-children' pk=DEFAULT_PK %}".replace("{{ DEFAULT_PK }}", parentNode.meta.node.id);
            console.log(url);
            $.post(url, {}, function (data, status) {
                if(status === "success"){
                    var newNode = {
                        id: data["key"],
                        name: data["value"],
                        pId: parentNode.id,
                        meta: {
                            "node": data
                        }
                    };
                    newNode.checked = zTree.getSelectedNodes()[0].checked;
                    zTree.addNodes(parentNode, 0, newNode);
                }else {
                    alert("创建节点失败！")
                }
            });
		}
		function removeTreeNode() {
			hideRMenu();
			var nodes = zTree.getSelectedNodes();
			if (nodes && nodes.length>0) {
				if (nodes[0].children && nodes[0].children.length > 0) {
					var msg = "要删除的节点是父节点，如果删除将连同子节点一起删掉。\n\n请确认！";
					if (confirm(msg)==true){
						zTree.removeNode(nodes[0]);
					}
				} else {
					zTree.removeNode(nodes[0]);
				}
			}
		}
		function checkTreeNode(checked) {
			var nodes = zTree.getSelectedNodes();
			if (nodes && nodes.length>0) {
				zTree.checkNode(nodes[0], checked, true);
			}
			hideRMenu();
		}
		function resetTree() {
			hideRMenu();
			$.fn.zTree.init($("#treeDemo"), setting, zNodes);
		}

		var zTree, rMenu;
		function initTree(){
		    if(zTree){
		        return;
            }
		    var url = '{% url 'node-children' %}';
            var setting = {
                    view: {
                        dblClickExpand: false,
                        showLine: true
                    },
                    data: {
                        simpleData: {
                            enable: true
                        }
                    },
                    async: {
                        enable: true,
                        url: url,
                        autoParam: ["id=key", "name=n", "level=lv"],
                        type: 'get'
                    },
                    edit: {
                        enable: true,
                        showRemoveBtn: false,
                        showRenameBtn: false,
                        drag: {
                            isCopy: true,
                            isMove: true
                        }
                    },
                    callback: {
                        onRightClick: OnRightClick,
                    }
                };
            var zNodes = [];
            zTree = $.fn.zTree.init($("#treeDemo"), setting, zNodes);
            rMenu = $("#rMenu");
        }
		$(document).ready(function(){
		    initTree();
		});
		</script>
{% endblock %}